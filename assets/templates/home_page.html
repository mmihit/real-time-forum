<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forum</title>
  </head>

  <body>
    <header>
      <nav>
        {{with . }}
        <a href="/" alt="home" id="logo">01 Forum</a>
        <a href="/logout?user={{.UserName}}" alt="logout" id="logout-btn"
          ><button>Logout</button></a
        >
        <a
          href="/posts/create?user={{.UserName}}"
          alt="create post"
          id="create-post-btn"
          ><button>Create Post</button></a
        >
        <button id="my-posts-btn">My Posts</button>
        {{else}}
        <a href="/" alt="home" id="logo">01 Forum</a>
        <a href="/register" alt="register"><button>Register</button></a>
        <a href="/login" alt="login"><button>Login</button></a>
        {{end}}
      </nav>
    </header>
    <main>
      <h2>Posts</h2>
    </main>
    <footer>
      <script>
        let timer;
        const fetchApi = async (url) => {
          let req = await fetch(url);
          let jsonData = await req.json();
          return jsonData;
        };

        let postsContainer = document.createElement("div");
        postsContainer.setAttribute("id", "posts-container");

        const loadPosts = async (userName, postsNum = 4) => {
          let i = 0;
          let apiData = userName
            ? await fetchApi(`/api/users/${userName}`)
            : await fetchApi("/api/posts");

          let posts = userName ? apiData.posts : apiData;
          while (i < postsNum) {
            displayPosts(posts);
            i++;
            if (i == posts.total) {
              clearTimeout(timer);
            }
          }
        };

        function displayPosts(posts) {
          posts.forEach((post) => {
            let postDiv = document.createElement("div");
            postDiv.className = "post";
            let userDiv = document.createElement("div");
            userDiv.className = "user";
            let userNameDiv = document.createElement("div");
            userNameDiv.className = "user-name";
            userNameDiv.textContent = post.user;
            let userImg = document.createElement("img");
            userImg.className = "user-img";
            userImg.src = "";
            let creationDateDiv = document.createElement("div");
            creationDateDiv.className = "creation-date";
            creationDateDiv.textContent = post.creationDate;
            userDiv.appendChild(userNameDiv, userImg, creationDateDiv);
            let titleDiv = document.createElement("div");
            titleDiv.className = "title";
            titleDiv.textContent = post.title;
            let contentDiv = document.createElement("div");
            contentDiv.className = "content";
            contentDiv.textContent = post.content;
            let commentContainerDiv = document.createElement("div");
            commentContainerDiv.className = "comment-arae";
            let commentInput = document.createElement("textarea");
            commentInput.className = "comment-input";
            commentContainerDiv.append(commentInput);
            postDiv.append(userDiv, titleDiv, contentDiv, commentContainerDiv);
            postsContainer.appendChild(postDiv);
          });
        }

        document.body.appendChild(postsContainer);
        timer = setTimeout(loadPosts(), 500);
        ("{{with .}}");
        document
          .getElementById("my-posts-btn")
          .addEventListener("click", function (event) {
            document.getElementById("posts-container").innerHTML = "";
            loadPosts("{{.UserName}}");
          });
        ("{{end}}");

        window.addEventListener("scroll", () => {
          if (
            window.scrollY + window.innerHeight >=
            document.documentElement.scrollHeight
          ) {
            loadPosts();
          }
        });
      </script>
    </footer>
  </body>
</html>
